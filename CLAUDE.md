# OK to Eat - UK Food Hygiene Ratings

SEO microsite displaying food hygiene ratings for ~600,000 UK food businesses.

**Domain:** oktoeat.co.uk

**Data Source:** Food Standards Agency (FSA) bulk CSV under Open Government Licence

---

## Architecture

This project follows the same architecture as doineedabrolly and whatsportisontoday:

- **Framework:** React 19 + Vike + vike-photon (SSR)
- **Build:** Vite
- **Server:** Hono (API routes)
- **Database:** Cloudflare D1 (SQLite)
- **Deployment:** Cloudflare Workers

---

## AI Assistant Restrictions

**CRITICAL: The following actions are STRICTLY FORBIDDEN:**

1. **NO DEPLOYMENTS** - Never deploy to any environment
2. **NO GIT COMMITS** - Never commit or push changes

The user maintains full control over deployments and version control.

---

## Project Structure

```
oktoeat/
├── package.json              # Root orchestrator
├── frontend/
│   ├── package.json
│   ├── wrangler.jsonc        # Cloudflare config with D1 binding
│   ├── vite.config.ts
│   ├── server/
│   │   └── index.ts          # Hono API routes + sitemaps + scheduled handler
│   ├── pages/                # Vike file-based routing
│   │   ├── index/            # Homepage
│   │   ├── business/@slug/   # Individual business pages
│   │   ├── area/@areaSlug/   # Location pages
│   │   │   ├── best/         # Best rated in location
│   │   │   ├── worst/        # Worst rated in location
│   │   │   └── @typeSlug/    # Business type pages
│   │   ├── about/
│   │   ├── privacy/
│   │   └── terms/
│   ├── src/
│   │   ├── components/       # React components
│   │   └── styles/           # CSS variables and global styles
│   ├── functions/_shared/    # Business logic
│   │   ├── types.ts
│   │   ├── db.ts             # D1 queries
│   │   ├── slugify.ts
│   │   └── import.ts         # CSV import for scheduled worker
│   └── scripts/
│       ├── schema.sql        # D1 schema
│       └── import-csv.ts     # Local CSV import script
```

---

## Setup

### 1. Create D1 Database

```bash
cd frontend
wrangler d1 create oktoeat-db
```

Copy the database_id to wrangler.jsonc.

### 2. Initialize Schema

```bash
npm run db:init        # Local
npm run db:init:remote # Remote
```

### 3. Import Data

For initial import (local development):
```bash
npx tsx scripts/import-csv.ts
```

For remote:
```bash
npx tsx scripts/import-csv.ts --remote
```

### 4. Run Development Server

```bash
npm run dev
```

---

## URL Structure

| Route | Purpose |
|-------|---------|
| `/` | Homepage with search |
| `/business/:slug` | Individual business page |
| `/area/:slug` | Location overview |
| `/area/:slug/best` | Best rated (4-5 stars) |
| `/area/:slug/worst` | Worst rated (0-2 stars) |
| `/area/:slug/:type` | Business type in location |

---

## API Routes

| Route | Purpose |
|-------|---------|
| `GET /api/search?q=` | Search businesses/locations |
| `GET /api/business/:slug` | Get business details |
| `GET /api/area/:slug` | Get location details |
| `GET /api/area/:slug/businesses` | Paginated businesses |
| `GET /api/area/:slug/best` | Best rated businesses |
| `GET /api/area/:slug/worst` | Worst rated businesses |
| `GET /api/area/:slug/types` | Business types in location |
| `GET /api/areas` | All locations |
| `GET /api/areas/top` | Top locations by count |
| `GET /api/types` | All business types |
| `GET /api/stats` | Homepage stats |
| `POST /api/import` | Manual import trigger (requires secret) |

---

## Sitemaps

Dynamic sitemaps generated by the server:

- `/sitemap.xml` - Index
- `/sitemap-static.xml` - Static pages
- `/sitemap-locations.xml` - All location pages
- `/sitemap-businesses-{n}.xml` - Business pages (50k per file)

---

## Data Refresh

The FSA data is refreshed weekly via Cloudflare Cron Trigger (Sunday 3am UTC).

The scheduled handler is defined in `server/index.ts` and calls `runScheduledImport()`.

---

## Environment Variables

Set in Cloudflare dashboard or `.dev.vars`:

- `IMPORT_SECRET` - Secret for manual import API endpoint

---

## Commands

```bash
npm run dev              # Development server
npm run build            # Production build
npm run typecheck        # Type check
npm run db:init          # Initialize local D1
npm run db:init:remote   # Initialize remote D1
```

---

## DEPLOYMENT CHECKLIST (TODO)

**Status: Ready for first deployment**

### Pre-deployment steps:

- [ ] **1. Initialize remote D1 schema:**
  ```bash
  cd oktoeat
  npm run db:init:remote
  ```

- [ ] **2. Import data to remote D1:**
  ```bash
  cd oktoeat/frontend
  npx tsx scripts/import-csv.ts --remote
  ```
  (Takes a while - 600k records)

- [ ] **3. Set up Cloudflare:**
  - Add `oktoeat.co.uk` domain to Cloudflare
  - In Workers → oktoeat → Settings → Variables → Add `IMPORT_SECRET` (any secure string)

- [ ] **4. Deploy to Cloudflare Workers**

### Post-deployment:

- [ ] Verify site works at https://oktoeat.co.uk
- [ ] Test search functionality
- [ ] Test a business page
- [ ] Test an area page
- [ ] Submit sitemap to Google Search Console (https://oktoeat.co.uk/sitemap.xml)
- [ ] Add Google verification meta tag to `pages/+Head.tsx` once received

### Completed items:

- [x] Local D1 with 603,546 records imported
- [x] Build passes
- [x] All SEO setup (structured data, OG images, icons, meta tags)
- [x] Sitemaps configured
- [x] robots.txt configured
- [x] Poppins font for display
- [x] Kabooly banner, OurPartners, Footer matching other sites
